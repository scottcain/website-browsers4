user daemon;
worker_processes  5;
daemon on;

worker_rlimit_nofile 65536;

# Error log; other directives: notice | info
error_log  /usr/local/wormbase/logs/nginx/error_log warn;

# pid file (defaults to logs)
pid        /usr/local/wormbase/logs/nginx.pid;

events {
    # Workers will die after this many requests.
    worker_connections  1024;
}


http {
    server_names_hash_bucket_size 64;

    # Optional: set up the access log and define a format
#    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                      '$status $body_bytes_sent "$http_referer" '
#                      '"$http_user_agent" "$http_x_forwarded_for"';
#                      '"$http_user_agent" "$http_x_forwarded_for"';
    log_format  main  '$remote_addr - $remote_user [$time_local] $http_referer '
                      '"$http_user_agent" "$request" $status $body_bytes_sent ';


    access_log /usr/local/wormbase/logs/nginx/access_log main;

    # log for cache hits.
    log_format cache '***$time_local '
	             '$upstream_cache_status '
                     'Cache-Control: $upstream_http_cache_control '
                     'Expires: $upstream_http_expires '
                     '"$request" ($status) '
		     '"$http_user_agent" ';


    sendfile        on;
    tcp_nopush      on;

    # TESTING OFF
    #tcp_nodelay     on;

    # TESTING AT 0: no keep-alive
    keepalive_timeout  0;
    #keepalive_timeout  65;


    # Suitable proxy defaults
    # Maximum time to connect to upstream servers
    proxy_connect_timeout           75s;
    # Maximum time to receive a response from upstream servers between read events
    proxy_read_timeout              120s;

    proxy_send_timeout              60s;
    proxy_buffer_size               4k;
    proxy_buffers                   4 32k;
    proxy_busy_buffers_size         64k;
    proxy_temp_file_write_size      64k;
    # proxy_set_header will ONLY be inherited for a 
    # given level if NO proxy_set_header entries are defined.
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Establish our cache
    # Multiple cache paths possible for different resources/paths/proxies
    # levels=1:2 specifies a hierarchy of two tiers.
    proxy_cache_path  /usr/local/wormbase/tmp/nginx-cache levels=1:2 keys_zone=thecache:100m max_size=1000m inactive=600m;
    proxy_temp_path   /usr/local/wormbase/tmp/nginx-cache-tmp;

    # Caching directives
    # proxy_cache_bypass $cookie___ac;
    proxy_cache thecache;
    proxy_cache_key $scheme$proxy_host$request_uri;

    # Request defaults
    client_max_body_size            0;
    client_body_buffer_size         128k;


#########################################################
#
# UPSTREAM TARGETS
#
#########################################################

    #################################
    # PRODUCTION
    #################################
    upstream production-webapp  {
	# may want to play with this to deal with TIME_WAIT requests
#	netstat -an|awk '/tcp/ {print $6}'|sort|uniq -c
#	keepalive SERVERS

        # WS246
	server 10.168.233.92:5000 weight=10 max_fails=4000 fail_timeout=1m;
	server 10.169.232.196:5000 weight=10 max_fails=4000 fail_timeout=1m;
    }  

    upstream production-botpot  {
	server 10.63.69.53:5000 weight=10 max_fails=4000 fail_timeout=1m;
    }

    # Data mining specific queries
    upstream production-mining {
       # WS246
       server 10.61.196.69:5000 weight=10 max_fails=200  fail_timeout=1m;
    }

    # Blast resides on its own instance for now.
    upstream production-blast {
       # WS246
       server 10.169.97.241:5000 weight=10 max_fails=200  fail_timeout=1m;
    }

    upstream production-gbrowse {
	# EC2 reserved and dedicated instance, with elastic IP and R53 entry.
        #	server gbrowse.wormbase.org weight=10 max_fails=2000 fail_timeout=1m;
        # WS246
	server 10.152.28.235:8000 weight=10 max_fails=2000 fail_timeout=1m;
    }

    upstream production-synteny {
	server 10.168.253.35:8001 weight=10 max_fails=2000 fail_timeout=1m;
    }



    #################################
    # The QA/QC website
    #################################
    upstream qaqc-webapp {
	server 10.154.246.80:5000 weight=10 max_fails=4000 fail_timeout=1m;
	server 10.169.232.196:5000 weight=10 max_fails=4000 fail_timeout=1m;
    }

#    upstream qaqc-gbrowse {
#        server ec2-50-17-136-209.compute-1.amazonaws.com:8000 weight=10 max_fails=2000 fail_timeout=1m;
#    }



    #################################
    # The staging website
    #################################
    upstream staging-webapp {   
       server dev.wormbase.org:5000 fail_timeout=1m;
    }

    # Note! There is specific development instance!
    # This all occurs on devs personal instances.
    # Note that this requires some files to be at website/production    
    upstream staging-gbrowse {
          server dev.wormbase.org:8000  weight=10 max_fails=2000 fail_timeout=1m;
    }

    upstream staging-synteny {
        server dev.wormbase.org:8001    weight=10 max_fails=2000 fail_timeout=1m; 
    }



    #################################
    # Mobile site
    #################################

    # The mobile site is currently hosted on the same host as the proxy
    upstream mobile  {
	server 127.0.0.1:10000    weight=10 max_fails=4000 fail_timeout=1m;
    }

    upstream mobiledev {
	server dev.wormbase.org:10000    weight=10 max_fails=4000 fail_timeout=1m;
    }

    #################################
    # Intermine
    #################################
    upstream intermine-production  {
         server 206.108.125.166:8080 weight=10 max_fails=200  fail_timeout=1m;
    }

    upstream intermine-staging  {
         server 206.108.125.174:8080 weight=10 max_fails=200  fail_timeout=1m;
    }


    #################################
    # Jenkins
    #################################
    upstream jenkins-server {
    	     server 23.23.228.211:8080 fail_timeout=0;
    }


    ##############################################################
    # 
    # Developer spaces, useful for testing app beahvior through
    # the proxy.
    #
    ##############################################################
    upstream development-jbrowse {
	# EC2 reserved and dedicated instance, with elastic IP and R53 entry.
	server dev.wormbase.org:8002 weight=10 max_fails=2000 fail_timeout=1m;	
    }

    upstream wormbase-development-todd {
    	     server dev.wormbase.org:9001 fail_timeout=1m;
    }

    upstream wormbase-development-todd-gbrowse {
    	     server dev.wormbase.org:10001 fail_timeout=1m;
    }

    upstream wormbase-development-sibyl {
    	     server dev.wormbase.org:9004 fail_timeout=1m;
    }

    upstream wormbase-development-juancarlos {
    	     server dev.wormbase.org:9005 fail_timeout=1m;
    }

    upstream wormbase-development-juancarlos-gbrowse {
    	     server dev.wormbase.org:10005 fail_timeout=1m;
    }

    upstream wormbase-development-thomas {
    	     server dev.wormbase.org:9006 fail_timeout=1m;
    }



    #################################
    # Couchdb
    #################################
    # Couchdb -- right here on localhost! How convenient.
    upstream couchdb {
        # EC2 couch
#        server 10.224.113.14:5984 weight=10 max_fails=2000 fail_timeout=1m;
#        server 10.101.22.233:5984 weight=10 max_fails=2000 fail_timeout=1m;
	server 127.0.0.1:5984 weight=10 max_fails=2000 fail_timeout=1m;
        # Using public elastic IP (which we should NOT be
        # doing as it incurs data transfer charges)
        # server 23.21.171.141:5984 weight=10 max_fails=2000 fail_timeout=1m;
    }              

    # Social services like the wiki, blog, and forums.
    # These are now all hosted on localhost on distinct ports
    # without using name based virtual hosts.
#    upstream wormbase-social {
#       server 23.21.171.141      weight=10 max_fails=2000 fail_timeout=1m; 
#       server 127.0.0.1:8080     weight=10 max_fails=2000 fail_timeout=1m; 
#    }



    #################################
    # Legacy and Archive sites
    #################################

    # 2014.wormbase.org. This is not a elastic IP!
    upstream legacy-2014 {
#       server ec2-54-162-190-73.compute-1.amazonaws.com:5000 max_fails=2000 fail_timeout=1m;
       server 10.136.113.45:5000 max_fails=2000 fail_timeout=1m;
    }

    upstream legacy-2014-gbrowse {
#        server ec2-54-162-190-73.compute-1.amazonaws.com:8000 max_fails=2000 fail_timeout=1m;
        server 10.136.113.45:8000 max_fails=2000 fail_timeout=1m;
    }



     map $http_user_agent $is_bot {
         default 0;
         ~(crawl|Googlebot|Google|Slurp|spider|bingbot|tracker|click|parser|spider|genie0217)$ 1;
#         ~(crawl|Slurp|spider|bingbot|tracker|click|parser|spider|genie0217)$ 1;
     }


#########################################################
#
# SERVER DEFINITIONS
#
#########################################################

    ########################################
    #
    #   Cache purging (on a dedicated port)
    #
    ########################################
#    server {
#        listen 8080;
#        access_log /usr/local/wormbase/logs/cache-purge/access_log;
#
#        location / {
#      	    allow  65.219.130.69;
#      	    deny   all;
#            proxy_cache_purge thecache $scheme$proxy_host$request_uri;
#        }
#    }

  ##################################
  #
  #  The production website
  # 
  ##################################
  server {
      server_name wormbase.org www.wormbase.org wormbase.net www.wormbase.net;
      listen      80;
		       
      access_log /usr/local/wormbase/logs/www/cache_log cache  buffer=16k;
      access_log /usr/local/wormbase/logs/www/access_log main  buffer=16k;
      error_log  /usr/local/wormbase/logs/www/error_log warn;

      # Enable gzip compression
      # Turn off if we're sitting behind a caching server.
#      gzip             on;
#      gzip_min_length  1000;
#      gzip_proxied     any;
#      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Force all users to use www.wormbase.org
      if ($host ~ ^(wormbase.org)) {
      	  #rewrite ^(.*) http://example.com$1 permanent;
          rewrite ^(.*) http://www.wormbase.org$1 permanent;          
      }

#      if ($is_bot) {
#           return 404; # Please respect the robots.txt file !
#      }

      # Only requests to our Host are allowed
      if ($host !~ ^(wormbase.org|www.wormbase.org|wormbase.net|www.wormbase.net)$ ) { 
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT|OPTIONS)$ ) {
         return 444;
      }
      
      #error_page  404              /404.html;
      # redirect server error pages to the static page /50x.html
      #
      #   error_page   500 502 503 504  /50x.html;
      #   location = /50x.html {
      # root   html;
      # }

      location /errors/system_maintenance.html {
          root /usr/local/wormbase/website;
      }

      # TEMPORARY HACK: Someone is targeting pry-1
#      location /species/c_elegans/gene/WBGene00004202 {
#          return 301;
#      }

      # System Maintenance (Service Unavailable)       
      if (-f "/usr/local/wormbase/system_maintenance.html" ) {
       	 return 503;
      }

      location /about/release_schedule {
           expires -1;
	   proxy_pass http://production-webapp;
      }

#       # Redirect mobile users to m.wormbase.org
#       set $mobile_rewrite do_not_perform;
 
#       # chi http_user_agent for mobile / smart phones
#       if ($http_user_agent ~* "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino") {
#           set $mobile_rewrite perform;
#        }
 
#        if ($http_user_agent ~* "^(1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-)") {
#           set $mobile_rewrite perform;
#        }

#       set $force_dt_cookie  "";
 
#       if ($args ~ 'desktop=true') {
#           set $mobile_rewrite do_not_perform;
#           set $force_dt_cookie  "desktop=true";
#       }
# 
#       add_header Set-Cookie $force_dt_cookie;
# 
#       if ($http_cookie ~ 'desktop=true') {
#          set $mobile_rewrite do_not_perform;
#       }
# 
#        # redirect to m.example.com
#        if ($mobile_rewrite = perform) {
#             rewrite ^ http://m.wormbase.org$request_uri? redirect;
#             break;
#         }

      # Forums, blog, and wiki (all legacy as these are now subdomains)
      location /forums { 
           rewrite forums(.*) http://forums.wormbase.org$1 permanent;
      }

      # Forums, blog, and wiki (all legacy as these are now subdomains)
      location /wiki { 
           rewrite wiki(.*) http://wiki.wormbase.org$1 permanent;
      }


# Our dedicated google instance.
#        if ($http_user_agent ~ "Googlebot" ) { 
#        if ($is_bot ) { 
#	      proxy_pass http://production-botpot;
#        }


      location /perl/ace { 
#           rewrite perl/ace/elegans/seq/sequence?gb=(.*) "http://www.wormbase.org/db/get?name=$2;class=sequence" permanent;
#           rewrite ^/perl/ace/elegans/seq/sequence\?gb=(.*)$ "http://www.wormbase.org/db/get?name=$1;class=sequence" permanent;
#	   rewrite perl/ace/elegans/seq/sequence\?gb=(.*) "http://www.wormbase.org/db/get?name=$1;class=sequence" permanent;
	   rewrite ^ "http://www.wormbase.org/db/get?name=$arg_gb;class=sequence?" permanent;
#           rewrite perl/ace(.*) http://forums.wormbase.org$1 permanent;
	    
      }    



       location / {
             if ($request_method = 'OPTIONS') { 	     
	             add_header 'Access-Control-Allow-Origin' '*';
        
	        #
        	# Om nom nom cookies
        	#
 
	        add_header 'Access-Control-Allow-Credentials' 'true';
        	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        
		#
        	# Custom headers and headers various browsers *should* be OK with but aren't
       		#
	 
		add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        
	        #
        	# Tell client that this pre-flight info is valid for 20 days
        	#
 
	        add_header 'Access-Control-Max-Age' 1728000;
        	add_header 'Content-Type' 'text/plain charset=UTF-8';
        	add_header 'Content-Length' 0;
 
	        return 204;
     	    }
 
	    if ($request_method = 'POST') {
 	       add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	    }
 
	    if ($request_method = 'GET') {
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	    }


           if ($http_user_agent ~* "blexbot|haosouspider|googlebot|yahoo|bingbot|baiduspider|yandex|yeti|yodaobot|gigabot|ia_archiver|facebookexternalhit|twitterbot|developers\.google\.com") {
                set $evilbot 1;
           }

           if ($evilbot = 1) {
	         proxy_pass http://production-botpot;
              }

	      proxy_pass http://production-webapp;

           # Caching diretives
#          proxy_cache_bypass $cookie___ac;
#          proxy_cache thecache;
#          proxy_cache_key $scheme$proxy_host$request_uri;

        }

	# Only triggered if /usr/local/wormbase/system_maintenance-on.html is present
        error_page 503 @maintenance;
        location @maintenance {
    	        root           /usr/local/wormbase/website/production/root/maintenance-mode;
                rewrite ^(.*)$ /503-system_maintenance.html break;
        }

        # Raw status information at /status
        location /stats/nginx/raw {
            stub_status on;
            allow  65.219.130.69;                
	    allow  10.245.30.22;
            deny   all;
        }

        location /stats/nginx {
#           allow  65.219.130.69;
#           deny   all;
            allow all;
	    root  /usr/local/wormbase/website-admin/nginx/production;
        }

        location /stats/starman/todd {
            allow all;
	    proxy_pass http://206.108.125.180:9001/server-status;
        }

#        location /stats/starman/staging {
#            allow all;
#	    proxy_pass http://206.108.125.164:5000/server-status;
#        }

        location /stats/starman/core1 {
            allow all;
	    proxy_pass http://10.98.131.95:5000/server-status;
        }

        location /stats/starman/core2 {
            allow all;
	    proxy_pass http://10.224.7.171:5000/server-status;
        }

	# Serve static files directly from nginx
#        location /css {
#            root  /usr/local/wormbase/website/production/root;
#        }
#        location /js {
#            root  /usr/local/wormbase/website/production/root;
#        }


        location /sitemaps {
            root  /usr/local/wormbase/website/production/root;
        }


        location /img {
            root  /usr/local/wormbase/website/production/root;
        }

	location /robots.txt {
	    root /usr/local/wormbase/website/production/root/html;
        }

	location /google7f93ee27d9252013.html {
	    root /usr/local/wormbase/website/production/root/html;
        }

        location /img-static {
            root  /usr/local/wormbase/website-shared-files/html;
        }

	# One-off hack for NCBI Linkout: 10/2012
        location /images/wdb.gif {
            root  /usr/local/wormbase/website-shared-files/html/img-static/wdb.gif;
        }

        location /docs {
            root  /usr/local/wormbase/website/production/root;
	}

	# The tmp dir is moving.
        location /tmp {
            root  /usr/local/wormbase/tmp;
        }

#       # Force all sessions into https
#       location / {
#            rewrite         ^/(.*)$ https://localhost:443/$1 permanent;
#        }

	 # Trap old requests for the genome browser.
        location /db/gb2/gbrowse/ {
	     rewrite ^/db/gb2/gbrowse/(.*)$ http://www.wormbase.org/tools/genome/gbrowse/$1 permanent;
        }


        location /tools/wormmine {
	#        location /wormmine {
            allow all;
            proxy_pass http://intermine-production/tools/wormmine;
        }

	# GBrowse, served by apache on a dedicated node.
	location /tools/genome {
	     proxy_pass http://production-gbrowse/tools/genome;
        }

        location /gbrowse-static/ {
	     proxy_pass http://production-gbrowse/gbrowse-static/;
        }

	# GBrowse, served by apache on a dedicated node.
	location /tools/synteny {
	     proxy_pass http://production-synteny/tools/synteny;
        }

	# GBrowse, served by a dedicated host.
        location /synteny/images/ {
	     proxy_pass http://production-gbrowse/synteny/images/;
        }

	# Send specific queries to wormbase mining
	location /rest/field {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/rest/field;
        }

	location /tools/blast_blat {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
#	     proxy_pass http://production-mining/tools/blast_blat;
	     proxy_pass http://production-blast/tools/blast_blat;
        }

	location /tools/epic {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epic;
        }

	location /tools/tree {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 404; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/tree;
        }

	location /tools/gmap {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/gmap;
        }

	location /tools/epcr {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epcr;
         }

	# And send temporary images generated by those tools to the correct server.
	location /media/images/blast_blat {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
#	     proxy_pass http://production-mining/media/images/blast_blat;
	     proxy_pass http://production-blast/media/images/blast_blat;
	}

	location /media/images/epic {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/media/images/epic;
	}


 	location /tools/queries {
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/queries;
        }
   }

    # HTTPs for logging in and registering.
    server {
        listen       443;
        server_name wormbase.org www.wormbase.org;
		      
        access_log /usr/local/wormbase/logs/ssl/cache_log cache  buffer=16k;
        access_log /usr/local/wormbase/logs/ssl/access_log main  buffer=16k;
        error_log  /usr/local/wormbase/logs/ssl/error_log warn;

        ssl                  on;
        ssl_certificate      /usr/local/wormbase/website-admin/nginx/ssl-certs/wormbase.org.chained.crt;
        ssl_certificate_key  /usr/local/wormbase/website-admin/nginx/ssl-certs/wormbase.org.key;
        ssl_session_timeout  5m;
        ssl_protocols  SSLv2 SSLv3 TLSv1;
        ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
        ssl_prefer_server_ciphers   on;

	location /robots.txt {
	    root /usr/local/wormbase/website/production/root/html;
        }

        location / {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }

              proxy_set_header Host $http_host;
              proxy_set_header X-Forwarded-Host $http_host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#	      proxy_set_header Origin http://beta.wormbase.org;
              proxy_set_header X-Forwarded-Port 443; #this is important for Catalyst Apps!
	      proxy_pass http://production-webapp;
	      proxy_redirect https://www.wormbase.org:443/ http://www.wormbase.org/;
         }

	 # Trap old requests for the genome browser.
        location /db/gb2/gbrowse/ {
	     rewrite ^/db/gb2/gbrowse/(.*)$ http://www.wormbase.org/tools/genome/gbrowse/$1 permanent;
        }

        location /tools/wormmine {
	#        location /wormmine {
            allow all;
            proxy_pass http://intermine-production/tools/wormmine;
        }

	# GBrowse, served by apache on a dedicated node.
	location /tools/genome {
	     proxy_pass http://production-gbrowse/tools/genome;
        }

        location /gbrowse-static/ {
	     proxy_pass http://production-gbrowse/gbrowse-static/;
        }

	# Send specific queries to wormbase mining
	location /tools/blast_blat {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
#	     proxy_pass http://production-mining/tools/blast_blat;
	     proxy_pass http://production-blast/tools/blast_blat;
        }

	location /tools/epic {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epic;
        }


	location /tools/tree {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epic;
	     return 404;
        }

	location /tools/gmap {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/gmap;
        }

	location /tools/epcr {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epcr;
         }

	# And send temporary images generated by those tools to the correct server.
	location /media/images/blast_blat {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
#	     proxy_pass http://production-mining/media/images/blast_blat;
	     proxy_pass http://production-blast/media/images/blast_blat;
	}

 	location /tools/queries {
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/queries;
        }
    }



#############################################
#  staging.wormbase.org
#############################################
  server {
      server_name staging.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/staging/cache_log cache;
      access_log /usr/local/wormbase/logs/staging/access_log main;
      error_log  /usr/local/wormbase/logs/staging/error_log warn;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(staging.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      if ($is_bot) {
           return 403; # Please respect the robots.txt file !
      }

      if ($http_user_agent ~ "Googlebot" ) { 
        return 403; 
      } 
      
      location /errors/system_maintenance.html {
          root /usr/local/wormbase/website;
      }

      # System Maintenance (Service Unavailable)       
      error_page 502 /errors/system_maintenance.html;


      location / {

             if ($request_method = 'OPTIONS') { 	     
	             add_header 'Access-Control-Allow-Origin' '*';
        
	        #
        	# Om nom nom cookies
        	#
 
	        add_header 'Access-Control-Allow-Credentials' 'true';
        	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        
		#
        	# Custom headers and headers various browsers *should* be OK with but aren't
        	#
 
		add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        
	        #
        	# Tell client that this pre-flight info is valid for 20 days
        	#
 
	        add_header 'Access-Control-Max-Age' 1728000;
        	add_header 'Content-Type' 'text/plain charset=UTF-8';
        	add_header 'Content-Length' 0;
 
	        return 204;
     	    }
 
	    if ($request_method = 'POST') {
 	       add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	    }
 
	    if ($request_method = 'GET') {
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	    }


          # Pool of PSGI/Starman hosts
	  proxy_pass http://staging-webapp;
       }


        location /tools/wormmine {
	#        location /wormmine {
            allow all;
#            proxy_pass http://intermine-production/tools/wormmine;
            proxy_pass http://intermine-staging/tools/wormmine;
        }


	location /tools/epic {
	return 502;
#                return 502; # Please respect the robots.txt file !
             if ($is_bot) {
                return 403; # Please respect the robots.txt file !
             }
	     proxy_pass http://production-mining/tools/epic;
        }

	location /robots.txt {
	    root /usr/local/wormbase/website/production/root/html;
        }

	# GBrowse, served by apache on a dedicated node.
	location /tools/genome {
	     proxy_pass http://staging-gbrowse/tools/genome;
        }

        location /gbrowse-static/ {
	     proxy_pass http://staging-gbrowse/gbrowse-static/;
        }


#        location /img-static {
#            proxy_pass http://staging-webapp;
#        }

#      # Force all sessions into https
#       location / {
#            rewrite         ^/(.*)$ https://localhost:443/$1 permanent;
#        }
   }



#############################################
#  m.wormbase.org
#############################################
  server {
      server_name m.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/mobile/cache_log cache;
      access_log /usr/local/wormbase/logs/mobile/access_log main;
      error_log  /usr/local/wormbase/logs/mobile/error_log warn;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(m.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      if ($is_bot) {
           return 403; # Please respect the robots.txt file !
      }

      if ($http_user_agent ~ "Googlebot" ) { 
         return 403; 
      } 
      
#      location /errors/system_maintenance.html {
#          root /usr/local/wormbase/website;
#      }
#
#      # System Maintenance (Service Unavailable)       
#      error_page 502 /errors/system_maintenance.html;

      location / {

             if ($request_method = 'OPTIONS') { 	     
	             add_header 'Access-Control-Allow-Origin' '*';
        
	        #
        	# Om nom nom cookies
        	#
 
	        add_header 'Access-Control-Allow-Credentials' 'true';
        	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        
		#
        	# Custom headers and headers various browsers *should* be OK with but aren't
        	#
 
		add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        
	        #
        	# Tell client that this pre-flight info is valid for 20 days
        	#
 
	        add_header 'Access-Control-Max-Age' 1728000;
        	add_header 'Content-Type' 'text/plain charset=UTF-8';
        	add_header 'Content-Length' 0;
 
	        return 204;
     	    }
 
	    if ($request_method = 'POST') {
 	       add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	    }
 
	    if ($request_method = 'GET') {
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	    }

	  proxy_pass http://mobile;
       }
   }



#############################################
#  m-dev.wormbase.org
#############################################
  server {
      server_name m-dev.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/m-dev.wormbase.org/cache_log cache;
      access_log /usr/local/wormbase/logs/m-dev.wormbase.org/access_log main;
      error_log  /usr/local/wormbase/logs/m-dev.wormbase.org/error_log warn;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(m-dev.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      if ($is_bot) {
           return 403; # Please respect the robots.txt file !
      }

      if ($http_user_agent ~ "Googlebot" ) { 
         return 403; 
      } 
      
#      location /errors/system_maintenance.html {
#          root /usr/local/wormbase/website;
#      }
#
#      # System Maintenance (Service Unavailable)       
#      error_page 502 /errors/system_maintenance.html;

      location / {

             if ($request_method = 'OPTIONS') { 	     
	             add_header 'Access-Control-Allow-Origin' '*';
        
	        #
        	# Om nom nom cookies
        	#
 
	        add_header 'Access-Control-Allow-Credentials' 'true';
        	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        
		#
        	# Custom headers and headers various browsers *should* be OK with but aren't
        	#
 
		add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        
	        #
        	# Tell client that this pre-flight info is valid for 20 days
        	#
 
	        add_header 'Access-Control-Max-Age' 1728000;
        	add_header 'Content-Type' 'text/plain charset=UTF-8';
        	add_header 'Content-Length' 0;
 
	        return 204;
     	    }
 
	    if ($request_method = 'POST') {
 	       add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	    }
 
	    if ($request_method = 'GET') {
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	    }

	  proxy_pass http://mobiledev;
       }
   }




  # 2014.wormbase.org
  server {
      server_name 2014.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/2014.wormbase.org/cache_log cache;
      access_log /usr/local/wormbase/logs/2014.wormbase.org/access_log main;
      error_log  /usr/local/wormbase/logs/2014.wormbase.org/error_log warn;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(2014.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      if ($is_bot) {
           return 403; # Please respect the robots.txt file !
      }

      if ($http_user_agent ~ "Googlebot" ) { 
         return 403; 
      } 
      
#      location /errors/system_maintenance.html {
#          root /usr/local/wormbase/website;
#      }
#
#      # System Maintenance (Service Unavailable)       
#      error_page 502 /errors/system_maintenance.html;

      location / {

             if ($request_method = 'OPTIONS') { 	     
	             add_header 'Access-Control-Allow-Origin' '*';
        
	        #
        	# Om nom nom cookies
        	#
 
	        add_header 'Access-Control-Allow-Credentials' 'true';
        	add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        
		#
        	# Custom headers and headers various browsers *should* be OK with but aren't
        	#
 
		add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
        
	        #
        	# Tell client that this pre-flight info is valid for 20 days
        	#
 
	        add_header 'Access-Control-Max-Age' 1728000;
        	add_header 'Content-Type' 'text/plain charset=UTF-8';
        	add_header 'Content-Length' 0;
 
	        return 204;
     	    }
 
	    if ($request_method = 'POST') {
 	       add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	    }
 
	    if ($request_method = 'GET') {
               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Credentials' 'true';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	    }

	  proxy_pass http://legacy-2014;
       }

	# GBrowse, served by apache on a dedicated node.
	location /tools/genome {
	     proxy_pass http://legacy-2014-gbrowse/tools/genome;
        }

        location /gbrowse-static/ {
	     proxy_pass http://legacy-2014-gbrowse/gbrowse-static/;
        }
   }





#############################################
#  qaqc.wormbase.org
#############################################
  server {
      server_name qaqc.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/qaqc/cache_log cache;
      access_log /usr/local/wormbase/logs/qaqc/access_log main;
      error_log  /usr/local/wormbase/logs/qaqc/error_log warn;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(qaqc.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      if ($http_user_agent ~ "Googlebot" ) { 
         return 403; 
      } 
      
      location /errors/system_maintenance.html {
          root /usr/local/wormbase/website;
      }

      # System Maintenance (Service Unavailable)       
      error_page 502 /errors/system_maintenance.html;

      location / {
          # Pool of PSGI/Starman hosts
	  proxy_pass http://qaqc-webapp;

          # Caching diretives
#         proxy_cache_bypass $cookie___ac;
#         proxy_cache thecache;
#         proxy_cache_key $scheme$proxy_host$request_uri;
       }


	# GBrowse, served by apache on a dedicated node.
#	location /tools/genome {
#	     proxy_pass http://qaqc-gbrowse/tools/genome;
#        }
#
#	location /robots.txt {
#	    root /usr/local/wormbase/website/production/root/html;
#        }
#
#        location /gbrowse-static/ {
#	     proxy_pass http://qaqc-gbrowse/gbrowse-static/;
#        }

#        location /img-static {
#            root  /usr/local/wormbase/website-shared-files/html;
#        }

#      # Force all sessions into https
#       location / {
#            rewrite         ^/(.*)$ https://localhost:443/$1 permanent;
#        }
   }


  ##################################
  #
  #  couchdb.wormbase.org
  # 
  ##################################
  server {
       listen 80;
       server_name couchdb.wormbase.org;
       access_log /usr/local/wormbase/logs/couchdb/access_log main;
       error_log  /usr/local/wormbase/logs/couchdb/error_log warn;
       location / {
	    proxy_pass http://couchdb/;	
        }
  }


  ##################################
  #
  #  admin (or maybe dashboard?).wormbase.org
  #  On the proxy node, serves up cost 
  #  and use reporting.
  #
  ##################################
  server {
       listen 80;
       server_name admin.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/blog.wormbase.org/current
       access_log /usr/local/wormbase/logs/admin.wormbase.org/access_log main;
       error_log  /usr/local/wormbase/logs/admin.wormbase.org/error_log warn;

       location / {
	    proxy_pass http://127.0.0.1:8084;
        }
  }


  ##################################
  #
  #  blog.wormbase.org
  #     EC2: 23.21.171.141
  ##################################
  server {
       listen 80;
       server_name blog.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/blog.wormbase.org/current
       access_log /usr/local/wormbase/logs/blog.wormbase.org/access_log main;
       error_log  /usr/local/wormbase/logs/blog.wormbase.org/error_log warn;

       location / {
#	    proxy_pass http://wormbase-social;
	    proxy_pass http://127.0.0.1:8080;
        }
  }

  ##################################
  #
  #  forums.wormbase.org
  # 
  ##################################
  server {
       listen 80;
       server_name forums.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/forum.wormbase.org/current
       access_log /usr/local/wormbase/logs/forums.wormbase.org/access_log main;
       error_log  /usr/local/wormbase/logs/forums.wormbase.org/error_log warn;
       location / {
#	    proxy_pass http://wormbase-social;
	    proxy_pass http://127.0.0.1:8081;
       }
  }

  ##################################
  #
  #  wiki.wormbase.org
  # 
  ##################################
  server {
       listen 80;
       server_name wiki.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/wiki.wormbase.org/current

       # Mediwiki sends some BIG headers!
       large_client_header_buffers 4 32k;

       access_log /usr/local/wormbase/logs/wiki.wormbase.org/access_log main;
       error_log  /usr/local/wormbase/logs/wiki.wormbase.org/error_log warn;
       location / {
#	    proxy_pass http://wormbase-social;
	    proxy_pass http://127.0.0.1:8082;
        }
  }


  ##################################
  #
  #  jbrowse.wormbase.org
  # 
  ##################################
  server {
       listen 80;
       server_name jbrowse.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/wiki.wormbase.org/current
	
       location /data/c_elegans/bigwig/ {
           #aio  on;
	   #sendfile off;
           
	   set $sent_http_content_disposition filename=$request_uri;
           # or
           # add_header content_disposition filename=$request_uri;

            set $sent_http_accept_ranges bytes;
	    # or
	    # add_header accept_ranges bytes;

	    # tell nginx that final HTTP Status Code should be 206 not 200
	    return 206;
        }    
   
       access_log /usr/local/wormbase/logs/jbrowse/access_log main;
       error_log  /usr/local/wormbase/logs/jbrowse/error_log warn;
       location / {
	    proxy_pass http://development-jbrowse;
        }
  }


  ##################################
  #
  #  evolution.wormbase.org
  #
  ##################################
  server {
       listen 80;
       server_name evolution.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/wiki.wormbase.org/current

       # Mediwiki sends some BIG headers!
       large_client_header_buffers 4 32k;

       access_log /usr/local/wormbase/logs/evolution.wormbase.org/access_log main;
       error_log  /usr/local/wormbase/logs/evolution.wormbase.org/error_log warn;
       location / {
#	    proxy_pass http://wormbase-social;
#	    proxy_pass http://10.38.175.22:8080;
	    proxy_pass http://127.0.0.1:8083;
        }
  }

  ##################################
  #
  #  api.wormbase.org
  # 
  ##################################
  server {
       listen 80;
       server_name api.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/blog.wormbase.org/current
       access_log /usr/local/wormbase/logs/api/access_log main;
       error_log  /usr/local/wormbase/logs/api/error_log warn;


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(api.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      location /robots.txt {
	    root /usr/local/wormbase/website/production/root/html;
      }

      location / {
          if ($is_bot) {
                return 403; # Please respect the robots.txt file !
          }
#	  proxy_pass http://production-mining;
	  proxy_pass http://production-webapp;
      }
  }




    ##############################################################
    # 
    # DEVELOPER
    # (mostly) dev.wormbase.org
    # Todd: 9001
    # Juancarlos: 9005
    ##############################################################
    server {
          server_name todd.wormbase.org;
    	  listen 80;
		     
          access_log /usr/local/wormbase/logs/todd/cache_log cache;
          access_log /usr/local/wormbase/logs/todd/access_log main;
          # Error log; other directives: notice | info
          error_log  /usr/local/wormbase/logs/todd/error_log warn;

          # Enable gzip compression
          gzip             on;
          gzip_min_length  1000;
          gzip_proxied     any;
          gzip_types       text/xml text/plain application/xml;

          include       mime.types;
          default_type  application/octet-stream;

          proxy_set_header Host $http_host;
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Connection Close;

          #############################################
          #
          # LOCKDOWN
          #
          #############################################
          # Only requests to our Host are allowed
          if ($host !~ ^(todd.wormbase.org)$ ) {
             return 444;
          }

          # Only allow these request methods
          if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
             return 444;
          }

          # No reason for bots to be crawling development sites.
          if ($is_bot) {
               return 403;
          }

          # Let's just be doubly sure...
          if ($http_user_agent ~ "Googlebot" ) { 
              return 403; 
          } 

          ##################################################
          # Common URLs
          ##################################################

          # Show status information on /status
          location = /status {
              stub_status on;
              allow 127.0.0.1;
              deny all;
          }

          location /errors/system_maintenance.html {
              root /usr/local/wormbase/website;
          }

          # System Maintenance (Service Unavailable)       
          error_page 502 /errors/system_maintenance.html;

          ##################################################
          # Document root: enable XSS for intermine integration
          ##################################################
          location / {
               if ($request_method = 'OPTIONS') { 	     
	            add_header 'Access-Control-Allow-Origin' '*';

             	    # Om nom nom cookies
	            add_header 'Access-Control-Allow-Credentials' 'true';
        	    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        	    # Custom headers and headers various browsers *should* be OK with but aren't
		    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

        	    # Tell client that this pre-flight info is valid for 20 days
	            add_header 'Access-Control-Max-Age' 1728000;
        	    add_header 'Content-Type' 'text/plain charset=UTF-8';
        	    add_header 'Content-Length' 0;
 
	            return 204;
     	        }
 
	        if ($request_method = 'POST') {
 	            add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	        }
 
	       if ($request_method = 'GET') {
                   add_header 'Access-Control-Allow-Origin' '*';
                   add_header 'Access-Control-Allow-Credentials' 'true';
                   add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                   add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	       }

 	       proxy_pass http://wormbase-development-todd;
          }

          ##################################################
          # Services shared across development instances
          ##################################################

          # Files in the shared static directory
#          location /img-static {
#                 root  /usr/local/wormbase/website-shared-files/html;
#          }

          # One off hack for NCBI Linkout: 10/2012. Annoying!
#          location /images/wdb.gif {
#                root  /usr/local/wormbase/website-shared-files/html/img-static/wdb.gif;
#          }

          # GBrowse - highly dependent on back end Apache configuration!
          location /tools/genome {
       	        proxy_pass http://wormbase-development-todd-gbrowse/tools/genome;
          }

          location /gbrowse-static/ {
          	     proxy_pass http://wormbase-development-todd-gbrowse/gbrowse-static/;
          }

          # The synteny browsing component of GBrowse.
          location /tools/synteny {
	         proxy_pass http://staging-synteny/tools/synteny;
          }

          # GBrowse, served by a dedicated host.
          location /synteny/images/ {
	         proxy_pass http://staging-synteny/synteny/images/;
          }

          location /tools/wormmine {
                allow all;
                 proxy_pass http://intermine-production/tools/wormmine;
          }
    }

    server {
          server_name sibyl.wormbase.org;
    	  listen 80;
		     
          access_log /usr/local/wormbase/logs/sibyl/cache_log cache;
          access_log /usr/local/wormbase/logs/sibyl/access_log main;
          # Error log; other directives: notice | info
          error_log  /usr/local/wormbase/logs/sibyl/error_log warn;

          # Enable gzip compression
          gzip             on;
          gzip_min_length  1000;
          gzip_proxied     any;
          gzip_types       text/xml text/plain application/xml;

          include       mime.types;
          default_type  application/octet-stream;

          proxy_set_header Host $http_host;
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Connection Close;

          #############################################
          #
          # LOCKDOWN
          #
          #############################################
          # Only requests to our Host are allowed
          if ($host !~ ^(sibyl.wormbase.org)$ ) {
             return 444;
          }

          # Only allow these request methods
          if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
             return 444;
          }

          # No reason for bots to be crawling development sites.
          if ($is_bot) {
               return 403;
          }

          # Let's just be doubly sure...
          if ($http_user_agent ~ "Googlebot" ) { 
              return 403; 
          } 

          ##################################################
          # Common URLs
          ##################################################

          # Show status information on /status
          location = /status {
              stub_status on;
              allow 127.0.0.1;
              deny all;
          }

          location /errors/system_maintenance.html {
              root /usr/local/wormbase/website;
          }

          # System Maintenance (Service Unavailable)       
          error_page 502 /errors/system_maintenance.html;



       # Redirect mobile users to a dev version of the mobile site on staging
       set $mobile_rewrite do_not_perform;
 
       # chi http_user_agent for mobile / smart phones
       if ($http_user_agent ~* "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino") {
           set $mobile_rewrite perform;
        }
 
        if ($http_user_agent ~* "^(1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-)") {
           set $mobile_rewrite perform;
        }

       set $force_dt_cookie  "";
 
       if ($args ~ 'desktop=true') {
           set $mobile_rewrite do_not_perform;
           set $force_dt_cookie  "desktop=true";
       }
 
       add_header Set-Cookie $force_dt_cookie;
 
       if ($http_cookie ~ 'desktop=true') {
          set $mobile_rewrite do_not_perform;
       }
 
        # redirect to m.example.com
        if ($mobile_rewrite = perform) {
             rewrite ^ http://m-dev.wormbase.org$request_uri? redirect;
             break;
         }



          ##################################################
          # Document root: enable XSS for intermine integration
          ##################################################
          location / {

#	       expires off;

               if ($request_method = 'OPTIONS') { 	     
	            add_header 'Access-Control-Allow-Origin' '*';

             	    # Om nom nom cookies
	            add_header 'Access-Control-Allow-Credentials' 'true';
        	    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        	    # Custom headers and headers various browsers *should* be OK with but aren't
		    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

        	    # Tell client that this pre-flight info is valid for 20 days
	            add_header 'Access-Control-Max-Age' 1728000;
        	    add_header 'Content-Type' 'text/plain charset=UTF-8';
        	    add_header 'Content-Length' 0;
 
	            return 204;
     	        }
 
	        if ($request_method = 'POST') {
 	            add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	        }
 
	       if ($request_method = 'GET') {
                   add_header 'Access-Control-Allow-Origin' '*';
                   add_header 'Access-Control-Allow-Credentials' 'true';
                   add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                   add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	       }

 	       proxy_pass http://wormbase-development-sibyl;
          }

          ##################################################
          # Services shared across development instances
          ##################################################

          # Files in the shared static directory
#          location /img-static {
#                 root  /usr/local/wormbase/website-shared-files/html;
#          }

#          # One off hack for NCBI Linkout: 10/2012. Annoying!
#          location /images/wdb.gif {
#                root  /usr/local/wormbase/website-shared-files/html/img-static/wdb.gif;
#          }

          # GBrowse - highly dependent on back end Apache configuration!
          location /tools/genome {
       	        proxy_pass http://staging-gbrowse/tools/genome;
          }

          # The synteny browsing component of GBrowse.
          location /tools/synteny {
	         proxy_pass http://staging-synteny/tools/synteny;
          }

          # GBrowse, served by a dedicated host.
          location /synteny/images/ {
	         proxy_pass http://staging-synteny/synteny/images/;
          }

          location /tools/wormmine {
                allow all;
                 proxy_pass http://intermine-production/tools/wormmine;
          }
    }




# Thomas: 9006    
server {
          server_name thomas.wormbase.org;
    	  listen 80;
		     
          access_log /usr/local/wormbase/logs/thomas/cache_log cache;
          access_log /usr/local/wormbase/logs/thomas/access_log main;
          # Error log; other directives: notice | info
          error_log  /usr/local/wormbase/logs/thomas/error_log warn;

          # Enable gzip compression
          gzip             on;
          gzip_min_length  1000;
          gzip_proxied     any;
          gzip_types       text/xml text/plain application/xml;

          include       mime.types;
          default_type  application/octet-stream;

          proxy_set_header Host $http_host;
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Connection Close;

          #############################################
          #
          # LOCKDOWN
          #
          #############################################
          # Only requests to our Host are allowed
          if ($host !~ ^(thomas.wormbase.org)$ ) {
             return 444;
          }

          # Only allow these request methods
          if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
             return 444;
          }

          # No reason for bots to be crawling development sites.
          if ($is_bot) {
               return 403;
          }

          # Let's just be doubly sure...
          if ($http_user_agent ~ "Googlebot" ) { 
              return 403; 
          } 

          ##################################################
          # Common URLs
          ##################################################

          # Show status information on /status
          location = /status {
              stub_status on;
              allow 127.0.0.1;
              deny all;
          }

          location /errors/system_maintenance.html {
              root /usr/local/wormbase/website;
          }

          # System Maintenance (Service Unavailable)       
          error_page 502 /errors/system_maintenance.html;



       # Redirect mobile users to a dev version of the mobile site on staging
       set $mobile_rewrite do_not_perform;
 
       # chi http_user_agent for mobile / smart phones
       if ($http_user_agent ~* "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino") {
           set $mobile_rewrite perform;
        }
 
        if ($http_user_agent ~* "^(1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-)") {
           set $mobile_rewrite perform;
        }

       set $force_dt_cookie  "";
 
       if ($args ~ 'desktop=true') {
           set $mobile_rewrite do_not_perform;
           set $force_dt_cookie  "desktop=true";
       }
 
       add_header Set-Cookie $force_dt_cookie;
 
       if ($http_cookie ~ 'desktop=true') {
          set $mobile_rewrite do_not_perform;
       }
 
        # redirect to m.example.com
        if ($mobile_rewrite = perform) {
             rewrite ^ http://m-dev.wormbase.org$request_uri? redirect;
             break;
         }



          ##################################################
          # Document root: enable XSS for intermine integration
          ##################################################
          location / {
               if ($request_method = 'OPTIONS') { 	     
	            add_header 'Access-Control-Allow-Origin' '*';

             	    # Om nom nom cookies
	            add_header 'Access-Control-Allow-Credentials' 'true';
        	    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        	    # Custom headers and headers various browsers *should* be OK with but aren't
		    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

        	    # Tell client that this pre-flight info is valid for 20 days
	            add_header 'Access-Control-Max-Age' 1728000;
        	    add_header 'Content-Type' 'text/plain charset=UTF-8';
        	    add_header 'Content-Length' 0;
 
	            return 204;
     	        }
 
	        if ($request_method = 'POST') {
 	            add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	        }
 
	       if ($request_method = 'GET') {
                   add_header 'Access-Control-Allow-Origin' '*';
                   add_header 'Access-Control-Allow-Credentials' 'true';
                   add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                   add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	       }

 	       proxy_pass http://wormbase-development-thomas;
          }

          ##################################################
          # Services shared across development instances
          ##################################################

          # Files in the shared static directory
#          location /img-static {
#                 root  /usr/local/wormbase/website-shared-files/html;
#          }

#          # One off hack for NCBI Linkout: 10/2012. Annoying!
#          location /images/wdb.gif {
#                root  /usr/local/wormbase/website-shared-files/html/img-static/wdb.gif;
#          }

          # GBrowse - highly dependent on back end Apache configuration!
          location /tools/genome {
       	        proxy_pass http://staging-gbrowse/tools/genome;
          }

          # The synteny browsing component of GBrowse.
          location /tools/synteny {
	         proxy_pass http://staging-synteny/tools/synteny;
          }

          # GBrowse, served by a dedicated host.
          location /synteny/images/ {
	         proxy_pass http://staging-synteny/synteny/images/;
          }

          location /tools/wormmine {
                allow all;
                 proxy_pass http://intermine-production/tools/wormmine;
          }
    }



    server {
          server_name juancarlos.wormbase.org;
    	  listen 80;
		     
          access_log /usr/local/wormbase/logs/juancarlos/cache_log cache;
          access_log /usr/local/wormbase/logs/juancarlos/access_log main;
          # Error log; other directives: notice | info
          error_log  /usr/local/wormbase/logs/juancarlos/error_log warn;

          # Enable gzip compression
          gzip             on;
          gzip_min_length  1000;
          gzip_proxied     any;
          gzip_types       text/xml text/plain application/xml;

          include       mime.types;
          default_type  application/octet-stream;

          proxy_set_header Host $http_host;
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header Connection Close;

          #############################################
          #
          # LOCKDOWN
          #
          #############################################
          # Only requests to our Host are allowed
          if ($host !~ ^(juancarlos.wormbase.org)$ ) {
             return 444;
          }

          # Only allow these request methods
          if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
             return 444;
          }

          # No reason for bots to be crawling development sites.
          if ($is_bot) {
               return 403;
          }

          # Let's just be doubly sure...
          if ($http_user_agent ~ "Googlebot" ) { 
              return 403; 
          } 

          ##################################################
          # Common URLs
          ##################################################

          # Show status information on /status
          location = /status {
              stub_status on;
              allow 127.0.0.1;
              deny all;
          }

          location /errors/system_maintenance.html {
              root /usr/local/wormbase/website;
          }

          # System Maintenance (Service Unavailable)       
          error_page 502 /errors/system_maintenance.html;

          ##################################################
          # Document root: enable XSS for intermine integration
          ##################################################
          location / {
               if ($request_method = 'OPTIONS') { 	     
	            add_header 'Access-Control-Allow-Origin' '*';

             	    # Om nom nom cookies
	            add_header 'Access-Control-Allow-Credentials' 'true';
        	    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        	    # Custom headers and headers various browsers *should* be OK with but aren't
		    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

        	    # Tell client that this pre-flight info is valid for 20 days
	            add_header 'Access-Control-Max-Age' 1728000;
        	    add_header 'Content-Type' 'text/plain charset=UTF-8';
        	    add_header 'Content-Length' 0;
 
	            return 204;
     	        }
 
	        if ($request_method = 'POST') {
 	            add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Credentials' 'true';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
     	        }
 
	       if ($request_method = 'GET') {
                   add_header 'Access-Control-Allow-Origin' '*';
                   add_header 'Access-Control-Allow-Credentials' 'true';
                   add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                   add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
	       }

 	       proxy_pass http://wormbase-development-juancarlos;
          }

          ##################################################
          # Services shared across development instances
          ##################################################

          # Files in the shared static directory
#          location /img-static {
#                 root  /usr/local/wormbase/website-shared-files/html;
#          }

#          # One off hack for NCBI Linkout: 10/2012. Annoying!
#          location /images/wdb.gif {
#                root  /usr/local/wormbase/website-shared-files/html/img-static/wdb.gif;
#          }

          # GBrowse - highly dependent on back end Apache configuration!
          location /tools/genome {
       	        proxy_pass http://wormbase-development-juancarlos-gbrowse/tools/genome;
          }

          location /gbrowse-static/ {
          	     proxy_pass http://wormbase-development-juancarlos-gbrowse/gbrowse-static/;
          }

          # The synteny browsing component of GBrowse.
          location /tools/synteny {
	         proxy_pass http://staging-synteny/tools/synteny;
          }

          # GBrowse, served by a dedicated host.
          location /synteny/images/ {
	         proxy_pass http://staging-synteny/synteny/images/;
          }

          location /tools/wormmine {
                allow all;
                 proxy_pass http://intermine-production/tools/wormmine;
          }
      }





#############################################
#  intermine.wormbase.org
#     PLEASE PRESERVE THIS REDIRECT 
#     TO HANDLE URLs PUBLISHED BEFORE
#     WE SETTLED ON A LOCATION.
#############################################
server {
      server_name intermine.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/intermine-redirector/cache_log cache;
      access_log /usr/local/wormbase/logs/intermine-redirector/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/intermine-redirector/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      if ($is_bot) {
           return 403; # Please respect the robots.txt file !
      }

      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(intermine.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

#      return 301 http://www.wormbase.org/tools/wormmine/$request_uri;
      return 301 http://www.wormbase.org/tools/wormmine;


#      location / {
#	    proxy_pass http://206.108.125.180:9002;
#       }

    }




    # Jenkins
    server {
    	   listen 80;
    	   listen [::]:80 default ipv6only=on;
    	   server_name jenkins.wormbase.org;

      	   access_log /usr/local/wormbase/logs/jenkins/cache_log cache  buffer=16k;
      	   access_log /usr/local/wormbase/logs/jenkins/access_log main  buffer=16k;
      	   error_log  /usr/local/wormbase/logs/jenkins/error_log warn;

    	   location / {
           	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	    proxy_set_header Host $http_host;
        	    proxy_redirect off;

        	    if (!-f $request_filename) {
            	       proxy_pass http://jenkins-server;
            	       break;
        	    }
           }
    }

}