user daemon;
worker_processes  5;
daemon on;

# Error log; other directives: notice | info
error_log  /usr/local/wormbase/logs/nginx/error_log warn;

# pid file (defaults to logs)
pid        /usr/local/wormbase/logs/nginx.pid;

events {
    # Workers will die after this many requests.
    worker_connections  1024;
}


http {
    server_names_hash_bucket_size 64;

    # Optional: set up the access log and define a format
#    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
#                      '$status $body_bytes_sent "$http_referer" '
#                      '"$http_user_agent" "$http_x_forwarded_for"';
#                      '"$http_user_agent" "$http_x_forwarded_for"';
    log_format  main  '$remote_addr - $remote_user [$time_local] $http_referer '
                      '"$http_user_agent" "$request" $status $body_bytes_sent ';


    access_log /usr/local/wormbase/logs/nginx/access_log main;

    # log for cache hits.
    log_format cache '***$time_local '
	             '$upstream_cache_status '
                     'Cache-Control: $upstream_http_cache_control '
                     'Expires: $upstream_http_expires '
                     '"$request" ($status) '
		     '"$http_user_agent" ';

    # Load-balancing against a pool of starman sockets.
    # Define as many servers as we have here and weight them.
    upstream wormbase  {
       # TCP socket
       # server 127.0.0.1:20000   # or unix socket or hostname      

       # NOT CONFIGURED
       # Amazon instance
       # server 50.19.229.229:5000 weight=10 max_fails=2000 fail_timeout=1m;
       
       # web1
       server 206.108.125.175:5000 weight=10 max_fails=2000 fail_timeout=1m;

       # web2
       server 206.108.125.177:5000 weight=10 max_fails=2000 fail_timeout=1m;

       # web3
       server 206.108.125.190:5000 weight=10 max_fails=2000 fail_timeout=1m;

       # NOT CONFIGURED
       # web4 - currently serving the classic site
       # server 206.108.125.168:5000 weight=10 max_fails=2000 fail_timeout=1m;

       # NOT CONFIGURED
	# mining
#       server 206.108.125.178:5000 weight=10 max_fails=2000 fail_timeout=1m;

	# NOT CONFIGURED
       # web6 (165) is our dedicated couch and mysql server. We can use it as a backup if needed.
       # server 206.108.125.165:5000 backup;	
    }  

    # The classic website
    upstream wormbase-classic  {
       # EC2 reserved instance
       server 50.19.229.229        weight=10 max_fails=2000 fail_timeout=1m;

       # web1 @ oicr
       # server 206.108.125.175:8080 weight=10 max_fails=200  fail_timeout=1m;

       # web4 @ oicr
       server 206.108.125.168:8080 weight=10 max_fails=200  fail_timeout=1m;
    }   

   # social services like the blog, wiki, and forums
   # Either at OICR or on EC2
   upstream wormbase-social {
      # EC2 
#      server 50.19.229.229        weight=10 max_fails=20000 fail_timeout=1m;

      # wb-social @ OICR
      server 206.108.125.176      weight=10 max_fails=2000 fail_timeout=1m; 
    }

    upstream wormbase-gbrowse {
       # EC2
#        server 50.19.229.229        weight=10 max_fails=2000 fail_timeout=1m;

        # OICR dedicated
        server 206.108.125.173      weight=10 max_fails=2000 fail_timeout=1m; 
    }

    upstream wormbase-mining {
         # wb-mining @ oicr
         server 206.108.125.178:8080 weight=10 max_fails=200  fail_timeout=1m;
    }

    # The staging machine
    upstream wormbase-staging {
       # aka wb-web7 @ oicr
       server 206.108.125.164:5000        weight=10 max_fails=2000 fail_timeout=1m;
    }

    # The legacy instance of the app
    upstream wormbase-legacy {
       # aka wb-web7 @ oicr
       server 206.108.125.164:8080        weight=10 max_fails=2000 fail_timeout=1m;
    }


    upstream couchdb  {
       server 206.108.125.165:5984 weight=10 max_fails=2000 fail_timeout=1m;
#       server 206.108.125.164:5984 weight=10 max_fails=2000 fail_timeout=1m;
#       server 206.108.125.163:5984 weight=10 max_fails=2000 fail_timeout=1m;
#       server 206.108.125.162:5984 weight=10 max_fails=2000 fail_timeout=1m;
#       server 206.108.125.166:5984 weight=10 max_fails=2000 fail_timeout=1m;
#
#       # 165 is our dedicated couch server, but we can use it as a backup if needed.
#       server 206.108.125.165:5984 backup;
    }              

    sendfile        on;
    tcp_nopush      on;

    # TESTING OFF
    #tcp_nodelay     on;

    # TESTING AT 0: no keep-alive
    keepalive_timeout  0;
    #keepalive_timeout  65;

    # Suitable proxy defaults
    # Maximum time to connect to upstream servers
    proxy_connect_timeout           75s;
    # Maximum time to receive a response from upstream servers between read events
    proxy_read_timeout              120s;


    proxy_send_timeout              60s;
    proxy_buffer_size               4k;
    proxy_buffers                   4 32k;
    proxy_busy_buffers_size         64k;
    proxy_temp_file_write_size      64k;
    # proxy_set_header will ONLY be inherited for a 
    # given level if NO proxy_set_header entries are defined.
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Establish our cache
    # Multiple cache paths possible for different resources/paths/proxies
    # levels=1:2 specifies a hierarchy of two tiers.
    proxy_cache_path  /usr/local/wormbase/tmp/nginx-cache levels=1:2 keys_zone=thecache:100m max_size=1000m inactive=600m;
    proxy_temp_path   /usr/local/wormbase/tmp/nginx-cache-tmp;

    # Caching directives
    # proxy_cache_bypass $cookie___ac;
    proxy_cache thecache;
    proxy_cache_key $scheme$proxy_host$request_uri;

    # Request defaults
    client_max_body_size            0;
    client_body_buffer_size         128k;


    ########################################
    #
    #   Cache purging (on a dedicated port)
    #
    ########################################
    server {
        listen 8080;
#        server_name www.example.com;
        access_log /usr/local/wormbase/logs/cache-purge/access_log;

        location / {
      	    allow  65.219.130.69;
      	    deny   all;
            proxy_cache_purge thecache $scheme$proxy_host$request_uri;
        }
    }


    ########################################
    #
    #   www.wormbase.org
    #
    ########################################
    server {
    	   server_name wormbase.org www.wormbase.org;      
	   listen      80;
	   
           # Logs
	   access_log /usr/local/wormbase/logs/www/cache_log cache buffer=16k;
      	   access_log /usr/local/wormbase/logs/www/access_log main buffer=16k;
      	   error_log  /usr/local/wormbase/logs/www/error_log warn  buffer=16k;

	   # gzip compression
      	   # Turn off if we're sitting behind a caching server.
	   #      gzip             on;
	   #      gzip_min_length  1000;
	   #      gzip_proxied     any;
	   #      gzip_types       text/xml text/plain application/xml;

      	   include       mime.types;
      	   default_type  application/octet-stream;

    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Connection Close;

 	   # LOCKDOWN: only requests to our host are allowed
	   if ($host !~ ^(wormbase.org|www.wormbase.org)$ ) {      	   
              return 444;
      	   }

      	   # Only allow these request methods
      	   if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
              return 444;
      	   }
      
	   # Forums, blog, and wiki (all legacy as these are now subdomains)
      	   location /forums {
 	      rewrite forums(.*) http://forums.wormbase.org$1 permanent;
           }

           location /wiki {
 	      rewrite wiki(.*) http://wiki.wormbase.org$1 permanent;
           }

      	   location /blog {
 	      rewrite blog(.*) http://blog.wormbase.org$1 permanent;
           }

      	   location /biomart/martview {
 	      rewrite ^ http://caprica.caltech.edu:9002/biomart/martview permanent;
           }


               # error_page  404              /404.html;

           # redirect server error pages to the static page /50x.html           
           # error_page   500 502 503 504  /50x.html;


           # Raw status information at /status
           location /stats/nginx/raw {
                stub_status on;
                allow  65.219.130.69;                
		allow  10.245.30.22;
                deny   all;
           }

           location /stats/nginx {
#                allow  65.219.130.69;
#                deny   all;
		 allow all;
		root  /usr/local/wormbase/website-admin/nginx/production;
           }

           location /stats/apache-ec2 {
#                allow  65.219.130.69;                
#                deny   all;
		 allow all;
		 proxy_pass http://50.19.229.229;
           }

           location /stats/apache-oicr {
#                allow  65.219.130.69;                
#                deny   all;
		 allow all;
#		 proxy_pass http://wormbase-classic;
		 proxy_pass http://206.108.125.175:8080;
           }


           error_page 503 /system_maintenance.html;

           location / {

     	       ###############################
	       #  Maintenance mode
	       ###############################
               if (-f /usr/local/wormbase/website/classic/html/system_maintenance.html) {
                    return 503;
               }
 
               if ($args ~* "%253bbs-1") {
	          rewrite ^ "http://www.wormbase.org/db/gene/gene?name=bbs-1;class=Gene" permanent;
	       }

               if ($args ~* "%3Dbbs-1") {
	          rewrite ^ "http://www.wormbase.org/db/gene/gene?name=bbs-1;class=Gene" permanent;
	       }

	        proxy_pass http://wormbase-classic;
            }

            location = /system_maintenance.html {
              root /usr/local/wormbase/website/classic/html/;
              internal;
           }

	    # Serve static files directly from nginx
            location /stylesheets {
                 root  /usr/local/wormbase/website/classic/html;
#   	          proxy_pass http://wormbase-classic;
            }

            location /js {
                 root  /usr/local/wormbase/website/classic/html;
#	        proxy_pass http://wormbase-classic;
            }

            # Mining specific requests: these could go to api.wormbase.org
            location /db/get {
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/aql_query {
#                proxy_pass http://206.108.125.178:8080/db/searches/aql_query;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/class_query {
#                proxy_pass http://206.108.125.178:8080/db/searches/class_query;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/wb_query {
#                proxy_pass http://206.108.125.178:8080/db/searches/wb_query;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/batch_genes {
#                proxy_pass http://206.108.125.178:8080/db/searches/batch_genes;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/advanced/dumper {
#                proxy_pass http://206.108.125.178:8080/db/searches/advanced/dumper;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/epcr {
#               proxy_pass http://206.108.125.178:8080/db/searches/epcr;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/strains {
#                proxy_pass http://206.108.125.178:8080/db/searches/strains;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/blast_blat {
#                proxy_pass http://206.108.125.178:8080/db/searches/blast_blat;
	        proxy_pass http://wormbase-mining;
            }

            location /db/searches/blat {
#                proxy_pass http://206.108.125.178:8080/db/searches/blat;
	        proxy_pass http://wormbase-mining;
            }

	    # Dynamic images. This a really tedious way of doing this.
	    location /dynamic_images/wb-web1 {
	        proxy_pass http://206.108.125.175:8080/;
#	        proxy_pass http://wormbase-classic;
            }

#	    location /dynamic_images/wb-web2 {
#	        proxy_pass http://206.108.125.177:8080/;
##	        proxy_pass http://wormbase-classic;
#            }

#	    location /dynamic_images/wb-web3 {
#	        proxy_pass http://206.108.125.190:8080/;
##	        proxy_pass http://wormbase-classic;
#            }
#
#	    location /dynamic_images/wb-web4 {
#	        proxy_pass http://206.108.125.168:8080/;
##	        proxy_pass http://wormbase-classic;
#            }

	    location /dynamic_images/wb-mining {
	        proxy_pass http://206.108.125.178:8080/;
#	        proxy_pass http://wormbase-classic;
            }

#        location /img {
#            root  /usr/local/wormbase/website/classic/root;
#        }

       # Synteny Browser
       location /db/gb2/gbrowse_syn  {
	     proxy_pass http://206.108.125.173:8080/db/gb2/gbrowse_syn;
#	     proxy_pass http://wormbase-gbrowse;
#             proxy_pass http://206.108.125.173/gbrowse-static/i/;
#             proxy_pass http://mckay.cshl.edu/cgi-bin/gbrowse_syn/compara;
       }

       location /gbrowse_syn/tmp  {
	     proxy_pass http://206.108.125.173:8080/gbrowse_syn/tmp;
       }

	# GBrowse support: this could probably be simplified.
       location /db/gb2 {
	        proxy_pass http://wormbase-gbrowse;
        }

       # Why?
       location /gb2 {
	        proxy_pass http://wormbase-gbrowse;
        }

        location /gbrowse2 {
	        proxy_pass http://wormbase-gbrowse;
        }

        location /gb2-support {
		proxy_pass http://wormbase-gbrowse;
        }

        location /gbrowse2/css {
#	        proxy_pass http://wormbase-gbrowse;
		proxy_pass http://wormbase-classic;
        }

        location gbrowse2/js {
	        proxy_pass http://wormbase-gbrowse;
        }

        location /gbrowse2/i/ {
	        proxy_pass http://wormbase-gbrowse;
        }

        location gbrowse_img {
	        proxy_pass http://wormbase-gbrowse;
        }
  }


  ##################################
  #
  #  blog.wormbase.org
  #     206.108.125.176
  # 
  ##################################
  server {
       listen 80;
       server_name blog.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/blog.wormbase.org/current
       access_log /usr/local/wormbase/logs/blog/access_log main;
       error_log  /usr/local/wormbase/logs/blog/error_log warn;

       location / {
	    proxy_pass http://206.108.125.176/;	    
        }
  }

  ##################################
  #
  #  forums.wormbase.org
  #     206.108.125.176
  # 
  ##################################
  server {
       listen 80;
       server_name forums.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/forum.wormbase.org/current
       access_log /usr/local/wormbase/logs/forum/access_log main;
       error_log  /usr/local/wormbase/logs/forum/error_log warn;
       location / {
#	    proxy_pass http://206.108.125.176/;
	    proxy_pass http://wormbase-social;
       }
  }

  ##################################
  #
  #  wiki.wormbase.org
  #     206.108.125.176
  # 
  ##################################
  server {
       listen 80;
       server_name wiki.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/wiki.wormbase.org/current
       access_log /usr/local/wormbase/logs/wiki/access_log main;
       error_log  /usr/local/wormbase/logs/wiki/error_log warn;
       location / {
	    proxy_pass http://206.108.125.176/;
        }
  }




  ##################################
  #
  #  couchdb.wormbase.org
  #     206.108.125.176
  # 
  ##################################
  server {
       listen 80;
       server_name couchdb.wormbase.org;
       access_log /usr/local/wormbase/logs/couchdb/access_log main;
       error_log  /usr/local/wormbase/logs/couchdb/error_log warn;

       location / {
	    proxy_pass http://206.108.125.165:5984/;	    
        }
  }




  ##################################
  #
  #  The beta website
  # 
  ##################################

# TO HANDLE!
# do not cache when users are logged in..
#        proxy_cache_bypass $cookie___ac;
#	    set $memcached_key $uri;
#    	    memcached_pass     name:11211;
#    	    default_type       text/html;
#    	    error_page         404 @fallback;

# deny access to .htaccess files, if Apache's document root
# concurs with nginx's one
#
#location ~ /\.ht {
#    deny  all;
#}
    
  server {
      server_name beta.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/beta/cache_log cache;
      access_log /usr/local/wormbase/logs/beta/access_log main;
      error_log  /usr/local/wormbase/logs/beta/error_log warn;

      # Enable gzip compression
      # Turn off if we're sitting behind a caching server.
#      gzip             on;
#      gzip_min_length  1000;
#      gzip_proxied     any;
#      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(beta.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }
      
      #error_page  404              /404.html;
      # redirect server error pages to the static page /50x.html
      #
      #   error_page   500 502 503 504  /50x.html;
      #   location = /50x.html {
      # root   html;
      # }

      location /errors/system_maintenance.html {
          root /usr/local/wormbase/website;
      }

      # System Maintenance (Service Unavailable)       
      #if (-f /usr/local/wormbase/system_maintenance.html ) {
      error_page 502 /errors/system_maintenance.html;
       #     return 502;
       #}

      


      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
       }

       # COUCH (THIS IS NOW A DISTINCT SUBDOMAIN)
       # Filter requests for our CouchDBs, assuming that dbs are named /ws*.
       location ~* ^/ws.* {

           # Send all PUT requests to our core CouchDB server.
       	   #      	if ($request_method = PUT) {
	   #      	   proxy_pass http://206.108.125.165:5984/;
	   #        }

	   # Send all GETs/PUTs to the same server.
	   # We COULD send PUTs to primary server above but distribute GETs here.
           proxy_pass http://couchdb;
       }

       location / {

            ########################################
            #  Pool of fastcgi sockets
            ######################################## 
#           include fastcgi_params; # We'll discuss this later
            # Unix socket
            # fastcgi_pass unix:/tmp/myapp.fcgi;

            ########################################
            #  Pool of PSGI/Starman hosts
            ######################################## 
	    # Seems that some PUTs are getting cached instead of being sent directly
	    # to the back end couch.
          
            # Proxy pass to our pool of servers
	    proxy_pass http://wormbase;
	    # Or to a local starman
	    # proxy_pass http://localhost:5000;
	      	# Back end server configuration
  #            root   html;
  #            index  index.html index.htm;

           # Caching diretives
#          proxy_cache_bypass $cookie___ac;
#          proxy_cache thecache;
#          proxy_cache_key $scheme$proxy_host$request_uri;

        }

	# Serve static files directly from nginx
        location /css {
            root  /usr/local/wormbase/website/production/root;
        }
        location /js {
            root  /usr/local/wormbase/website/production/root;
        }

        location /img {
            root  /usr/local/wormbase/website/production/root;
        }

	# We aren't really using this since images
        location /img-static {
            root  /usr/local/wormbase/website-shared-files/html;
        }

        location /docs {
            root  /usr/local/wormbase/website/production/root;
	}

	# The tmp dir is moving.
        location /tmp {
            root  /usr/local/wormbase/tmp;
        }


#       # Force all sessions into https
#       location / {
#            rewrite         ^/(.*)$ https://localhost:443/$1 permanent;
#        }


        # Register and auth via ssl
       location /auth/login {
            rewrite         ^/(.*)$ https://beta.wormbase.org:443/$1 permanent;
        }

       location /register.* {
            rewrite         ^/(.*)$ https://beta.wormbase.org:443/$1 permanent;
        }


        # GBrowse: Could also be localhost
	location /tools/genome {
             proxy_pass http://206.108.125.173/tools/genome;
#	     proxy_pass http://wormbase-gbrowse/;
         }

	location /tools/blast_blat {
             proxy_pass http://206.108.125.190:5000/tools/blast_blat;
#	     proxy_pass http://wormbase-gbrowse/;
         }


	    # Dynamic images. This a really tedious way of doing this.
	    # NOT YET IN PLACE FOR BETA. See API/Role/Object: tmp_image_dir 
#	    location /media/wb-web1 {
#	        proxy_pass http://206.108.125.175:5000/;
##	        proxy_pass http://wormbase-classic;
#            }
#
#	    location /dynamic_images/wb-web2 {
#	        proxy_pass http://206.108.125.177:8080/;
##	        proxy_pass http://wormbase-classic;
#            }

#	    location /dynamic_images/wb-web3 {
#	        proxy_pass http://206.108.125.190:8080/;
##	        proxy_pass http://wormbase-classic;
#            }
#
#	    location /dynamic_images/wb-web4 {
#	        proxy_pass http://206.108.125.168:8080/;
##	        proxy_pass http://wormbase-classic;
#            }
#
#	    location /dynamic_images/wb-mining {
#	        proxy_pass http://206.108.125.178:8080/;
#	        proxy_pass http://wormbase-classic;
#            }



        location /gbrowse2 {
             proxy_pass http://206.108.125.173/gbrowse2/;
#	     proxy_pass http://wormbase-gbrowse/;
        }

        location /gbrowse2/i/ {
             proxy_pass http://206.108.125.173/gbrowse2/i/;
#	     proxy_pass http://wormbase-gbrowse/;
        }

        location /gbrowse-static/i/ {
             proxy_pass http://206.108.125.173/gbrowse-static/i/;
#	     proxy_pass http://wormbase-gbrowse/;
        }
   }


    # HTTPs for logging in.
    server {
        listen       443;
        server_name  beta.wormbase.org;
        ssl                  on;
        ssl_certificate      /usr/local/wormbase/website-admin/nginx/production/server.crt;
        ssl_certificate_key  /usr/local/wormbase/website-admin/nginx/production/server.key;
        ssl_session_timeout  5m;

        ssl_protocols  SSLv2 SSLv3 TLSv1;
        ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
        ssl_prefer_server_ciphers   on;

        location / {
              proxy_set_header Host $http_host;
              proxy_set_header X-Forwarded-Host $http_host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Port 443; #this is important for Catalyst Apps!
              #proxy_pass http://beta.wormbase.org:5000; #changed from http://localhost:5000/ which was causing double forward slash problems in the url
	      proxy_pass http://wormbase; #changed from http://localhost:5000/ which was causing double forward slash problems in the url
         }

#        location / {
#            root   html;
#            index  index.html index.htm;
#        }
    }


  ##################################
  #
  #  api.wormbase.org
  #      Send API requests to a dedicated host
  #      206.108.125. 
  # 
  ##################################
  server {
       listen 80;
       server_name api.wormbase.org;
#       index       index.php index.html
#       root        /usr/local/wormbase/website/blog.wormbase.org/current
       access_log /usr/local/wormbase/logs/api/access_log main;
       error_log  /usr/local/wormbase/logs/api/error_log warn;


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(api.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }


       location / {
	    proxy_pass http://wormbase;
        }
  }



####################################################
#
#  Resources hosted on the current development 
#  server (wb-dev.oicr.on.ca; 206.108.125.180)
#
#     abby   : 9002
#     adrian : 9004
#     todd   : 9001
#     xshi   : 9003
#
####################################################

#############################################
#  abby.wormbase.org
#      starman 206.108125.180:9002
#############################################
server {
      server_name abby.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/abby/cache_log cache;
      access_log /usr/local/wormbase/logs/abby/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/abby/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(abby.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      location / {
	    proxy_pass http://206.108.125.180:9002;
       }

	# GBrowse
       	location /tools/genome {
       		proxy_pass http://206.108.125.173:8000/tools/genome;
	}

	location /gbrowse2 {
	     proxy_pass http://206.108.125.173:8000/gbrowse2/;
	}
	
	location /gbrowse2/i/ {
	     proxy_pass http://206.108.125.173:8000/tools/gbrowse2/i/;
	}
    }


#############################################
#  adrian.wormbase.org
#      starman 206.108.125.180:9004
#############################################
server {
      server_name adrian.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/adrian/cache_log cache;
      access_log /usr/local/wormbase/logs/adrian/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/adrian/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(adrian.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }

      location / {
	    proxy_pass http://206.108.125.180:9004;
       }

	# GBrowse
       	location /tools/genome {
       		proxy_pass http://206.108.125.173:8000/tools/genome;
	}

	location /gbrowse2 {
	     proxy_pass http://206.108.125.173:8000/gbrowse2/;
	}
	
	location /gbrowse2/i/ {
	     proxy_pass http://206.108.125.173:8000/tools/gbrowse2/i/;
	}
    }

#############################################
#
#  todd.wormbase.org
#       starman on 206.108.125.180:9001
#
#############################################

server {
      server_name todd.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/todd/cache_log cache;
      access_log /usr/local/wormbase/logs/todd/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/todd/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(todd.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }

      location / {
	    proxy_pass http://206.108.125.180:9001;
       }

	# GBrowse
       	location /tools/genome {
       		proxy_pass http://206.108.125.173:8000/tools/genome;
	}

	location /gbrowse2 {
	     proxy_pass http://206.108.125.173:8000/gbrowse2/;
	}
	
	location /gbrowse2/i/ {
	     proxy_pass http://206.108.125.173:8000/tools/gbrowse2/i/;
	}
    }


#############################################
#  xshi.wormbase.org
#     starman 206.108125.180:9003
#############################################
   server {
      server_name xshi.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/xshi/cache_log cache;
      access_log /usr/local/wormbase/logs/xshi/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/xshi/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(xshi.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }

      location / {
	    proxy_pass http://206.108.125.180:9003;
       }

	# GBrowse
       	location /tools/genome {
       		proxy_pass http://206.108.125.173:8000/tools/genome;
	}

	location /gbrowse2 {
	     proxy_pass http://206.108.125.173:8000/gbrowse2/;
	}

	location /gbrowse2/i/ {
	     proxy_pass http://206.108.125.173:8000/tools/gbrowse2/i/;
	}
   }



#############################################
#  staging.wormbase.org
#      wb-web7: 206.108.125.164:5000
#############################################
  server {
      server_name staging.wormbase.org;      
      listen      80;
		       
      access_log /usr/local/wormbase/logs/beta/cache_log cache;
      access_log /usr/local/wormbase/logs/beta/access_log main;
      error_log  /usr/local/wormbase/logs/beta/error_log warn;

      # Enable gzip compression
      # Turn off if we're sitting behind a caching server.
#      gzip             on;
#      gzip_min_length  1000;
#      gzip_proxied     any;
#      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Connection Close;


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(staging.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }
      
      #error_page  404              /404.html;
      # redirect server error pages to the static page /50x.html
      #
      #   error_page   500 502 503 504  /50x.html;
      #   location = /50x.html {
      # root   html;
      # }

      location /errors/system_maintenance.html {
          root /usr/local/wormbase/website;
      }

      # System Maintenance (Service Unavailable)       
      #if (-f /usr/local/wormbase/system_maintenance.html ) {
      error_page 502 /errors/system_maintenance.html;
       #     return 502;
       #}


      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
       }

       # COUCH (THIS IS NOW A DISTINCT SUBDOMAIN)
       # Filter requests for our CouchDBs, assuming that dbs are named /ws*.
       location ~* ^/ws.* {

           # Send all PUT requests to our core CouchDB server.
       	   #      	if ($request_method = PUT) {
	   #      	   proxy_pass http://206.108.125.165:5984/;
	   #        }

	   # Send all GETs/PUTs to the same server.
	   # We COULD send PUTs to primary server above but distribute GETs here.
           proxy_pass http://couchdb;
       }

       location / {

            ########################################
            #  Pool of fastcgi sockets
            ######################################## 
#           include fastcgi_params; # We'll discuss this later
            # Unix socket
            # fastcgi_pass unix:/tmp/myapp.fcgi;

            ########################################
            #  Pool of PSGI/Starman hosts
            ######################################## 
	    # Seems that some PUTs are getting cached instead of being sent directly
	    # to the back end couch.
          
            # Proxy pass to our pool of servers
	    proxy_pass http://wormbase-staging;

           # Caching diretives
#          proxy_cache_bypass $cookie___ac;
#          proxy_cache thecache;
#          proxy_cache_key $scheme$proxy_host$request_uri;

        }

	# We will NOT serve files directly for staging.
	# We want to be able to see what is available on the back end.
	# See configuration for www/beta if necessary.
#       # Force all sessions into https
#       location / {
#            rewrite         ^/(.*)$ https://localhost:443/$1 permanent;
#        }


        # Register and auth via ssl
       location /auth/login {
            rewrite         ^/(.*)$ https://beta.wormbase.org:443/$1 permanent;
        }

       location /register.* {
            rewrite         ^/(.*)$ https://beta.wormbase.org:443/$1 permanent;
        }


        # GBrowse: Could also be localhost
	location /tools/genome {
             proxy_pass http://206.108.125.164/tools/genome;
#	     proxy_pass http://wormbase-gbrowse/;
         }

	location /tools/blast_blat {
             proxy_pass http://206.108.125.190:5000/tools/blast_blat;
#	     proxy_pass http://wormbase-gbrowse/;
         }


	    # Dynamic images. This a really tedious way of doing this.
	    # NOT YET IN PLACE FOR BETA. See API/Role/Object: tmp_image_dir 
#	    location /media/wb-web1 {
#	        proxy_pass http://206.108.125.175:5000/;
##	        proxy_pass http://wormbase-classic;
#            }

	     # Ick!  How to handle?
        location /gbrowse2 {
             proxy_pass http://206.108.125.173/gbrowse2/;
#	     proxy_pass http://wormbase-gbrowse/;
        }

        location /gbrowse2/i/ {
             proxy_pass http://206.108.125.173/gbrowse2/i/;
#	     proxy_pass http://wormbase-gbrowse/;
        }

        location /gbrowse-static/i/ {
             proxy_pass http://206.108.125.173/gbrowse-static/i/;
#	     proxy_pass http://wormbase-gbrowse/;
        }
   }


#############################################
#  legacy.wormbase.org
#      The old website, preserved for posterity
#      wb-web7: 206.108.125.164:8000
#############################################
server {
      server_name legacy.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/legacy/cache_log cache;
      access_log /usr/local/wormbase/logs/legacy/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/staging/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }


    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Connection Close;

 	   # LOCKDOWN: only requests to our host are allowed
	   if ($host !~ ^(legacy.wormbase.org)$ ) {
             return 444;
      	   }

      	   # Only allow these request methods
      	   if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
              return 444;
      	   }
      

      	   location /biomart/martview {
 	      rewrite ^ http://caprica.caltech.edu:9002/biomart/martview permanent;
           }

           # error_page  404              /404.html;

           # redirect server error pages to the static page /50x.html           
           # error_page   500 502 503 504  /50x.html;

           # System Maintenance (Service Unavailable) 
           # Config broken?
           # if (-f $document_root/system_maintenance.html ) {
           #        error_page 503 /system_maintenance.html;
           #        return 503;
           #      }
	  
           location / {
	        proxy_pass http://wormbase-legacy;
            }
    }


#############################################
#  qaqc.wormbase.org
#      starman 206.108.125.180:9002  PORT?
#############################################
server {
      server_name qaqc.wormbase.org;
      listen 80;
		       
      access_log /usr/local/wormbase/logs/qaqc/cache_log cache;
      access_log /usr/local/wormbase/logs/qaqc/access_log main;
      # Error log; other directives: notice | info
      error_log  /usr/local/wormbase/logs/qaqc/error_log warn;

      # Enable gzip compression
      gzip             on;
      gzip_min_length  1000;
      gzip_proxied     any;
      gzip_types       text/xml text/plain application/xml;

      include       mime.types;
      default_type  application/octet-stream;

      # Show status information on /status
      location = /status {
          stub_status on;
          allow 127.0.0.1;
          deny all;
      }


      #############################################
      #
      # LOCKDOWN
      #
      #############################################      

      # Only requests to our Host are allowed
      if ($host !~ ^(qaqc.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

      location / {
	    proxy_pass http://206.108.125.180:9002;  # PORT?
       }

	# GBrowse
       	location /tools/genome {
       		proxy_pass http://206.108.125.173:8000/tools/genome;
	}

	location /gbrowse2 {
	     proxy_pass http://206.108.125.173:8000/gbrowse2/;
	}
	
	location /gbrowse2/i/ {
	     proxy_pass http://206.108.125.173:8000/tools/gbrowse2/i/;
	}
    }


  ##################################
  #
  #  Frozen releases: all hosted on 
  #     206.108.125.181 (wb-dev2.oicr.on.ca)
  # 
  ##################################
  server {
       listen 80;
       server_name ws100.wormbase.org;
       access_log /usr/local/wormbase/logs/ws100/access_log main;
       error_log  /usr/local/wormbase/logs/ws100/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws100.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws110.wormbase.org;
       access_log /usr/local/wormbase/logs/ws110/access_log main;
       error_log  /usr/local/wormbase/logs/ws110/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws110.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws120.wormbase.org;
       access_log /usr/local/wormbase/logs/ws120/access_log main;
       error_log  /usr/local/wormbase/logs/ws120/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws120.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws130.wormbase.org;
       access_log /usr/local/wormbase/logs/ws130/access_log main;
       error_log  /usr/local/wormbase/logs/ws130/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws130.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws140.wormbase.org;
       access_log /usr/local/wormbase/logs/ws140/access_log main;
       error_log  /usr/local/wormbase/logs/ws140/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws140.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws150.wormbase.org;
       access_log /usr/local/wormbase/logs/ws150/access_log main;
       error_log  /usr/local/wormbase/logs/ws150/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws150.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws160.wormbase.org;
       access_log /usr/local/wormbase/logs/ws160/access_log main;
       error_log  /usr/local/wormbase/logs/ws160/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws160.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws170.wormbase.org;
       access_log /usr/local/wormbase/logs/ws170/access_log main;
       error_log  /usr/local/wormbase/logs/ws170/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws170.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws180.wormbase.org;
       access_log /usr/local/wormbase/logs/ws180/access_log main;
       error_log  /usr/local/wormbase/logs/ws180/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws180.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws190.wormbase.org;
       access_log /usr/local/wormbase/logs/ws190/access_log main;
       error_log  /usr/local/wormbase/logs/ws190/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws190.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws200.wormbase.org;
       access_log /usr/local/wormbase/logs/ws200/access_log main;
       error_log  /usr/local/wormbase/logs/ws200/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws200.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws204.wormbase.org;
       access_log /usr/local/wormbase/logs/ws204/access_log main;
       error_log  /usr/local/wormbase/logs/ws204/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws204.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws205.wormbase.org;
       access_log /usr/local/wormbase/logs/ws205/access_log main;
       error_log  /usr/local/wormbase/logs/ws205/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws205.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws210.wormbase.org;
       access_log /usr/local/wormbase/logs/ws210/access_log main;
       error_log  /usr/local/wormbase/logs/ws210/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws210.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws220.wormbase.org;
       access_log /usr/local/wormbase/logs/ws220/access_log main;
       error_log  /usr/local/wormbase/logs/ws220/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws220.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }

  server {
       listen 80;
       server_name ws225.wormbase.org;
       access_log /usr/local/wormbase/logs/ws225/access_log main;
       error_log  /usr/local/wormbase/logs/ws225/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws225.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;
        }
  }


  server {
       listen 80;
       server_name ws230.wormbase.org;
       access_log /usr/local/wormbase/logs/ws230/access_log main;
       error_log  /usr/local/wormbase/logs/ws230/error_log warn;

      #############################################
      #
      # LOCKDOWN
      #
      #############################################
      # Only requests to our Host are allowed
      if ($host !~ ^(ws230.wormbase.org)$ ) {
         return 444;
      }

      # Only allow these request methods
      if ($request_method !~ ^(GET|HEAD|POST|PUT)$ ) {
         return 444;
      }

       location / {
	    proxy_pass http://206.108.125.181/;	   
        }
  }
}

